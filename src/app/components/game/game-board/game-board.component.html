@if (state) {
  <div class="game-board">
    <!-- Phase Bar -->
    <app-phase-bar
      [state]="state"
      (advance)="gameService.advancePhase()"
      (toggleLog)="toggleLog()"
    />

    <!-- Opponent Area (top) -->
    <app-player-area
      [player]="state.activePlayerId === state.player1.id ? state.player2 : state.player1"
      [isActive]="false"
      [state]="state"
      class="opponent-area"
    />

    <!-- Divider -->
    <div class="board-divider">
      <span class="divider-info">Tour {{ state.turnNumber }}</span>
    </div>

    <!-- Active Player Area (bottom) -->
    <app-player-area
      [player]="state.activePlayerId === state.player1.id ? state.player1 : state.player2"
      [isActive]="true"
      [state]="state"
      class="active-area"
    />

    <!-- Mulligan Overlay -->
    @if (isMulliganPhase) {
      <app-mulligan-overlay [state]="state" [isAiGame]="!!state.isAiGame" />
    }

    <!-- Combat Overlay -->
    @if (showCombatOverlay && !shouldHideCombatOverlay) {
      <app-combat-overlay [state]="state" />
    }

    <!-- Targeting Overlay -->
    @if (state.pendingEffect && state.pendingEffect.ownerId !== 'player2') {
      <app-targeting-overlay [state]="state" />
    }

    <!-- AI Thinking Banner -->
    @if (isAiTurn && !showTransition) {
      <div class="ai-thinking-banner">
        <i class="pi pi-spin pi-cog"></i>
        <span>L'IA réfléchit...</span>
      </div>
    }

    <!-- Opponent Disconnected Banner -->
    @if (opponentDisconnected) {
      <div class="disconnect-banner opponent-disconnected">
        <i class="pi pi-exclamation-triangle"></i>
        <span>Adversaire déconnecté - Reconnexion possible jusqu'à {{ disconnectDeadline | date:'HH:mm:ss' }}</span>
      </div>
    }

    <!-- Reconnecting Banner -->
    @if (isReconnecting) {
      <div class="disconnect-banner reconnecting">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Reconnexion en cours...</span>
      </div>
    }

    <!-- Tutorial Overlay -->
    @if (tutorialService.isActive) {
      <app-tutorial-overlay [state]="state" />
    }

    <!-- Turn Transition -->
    @if (showTransition) {
      <app-turn-transition
        [playerName]="state.activePlayerId === state.player1.id ? state.player1.name : state.player2.name"
        [turnNumber]="state.turnNumber"
        (dismiss)="onTransitionDismiss()"
      />
    }

    <!-- Game Log Sidebar -->
    <app-game-log [log]="state.log" [visible]="showLog" (visibleChange)="showLog = $event" />

    <!-- Manual Actions -->
    <app-manual-actions [state]="state" />

    <!-- Emotes, Chat & Turn Timer (online games only) -->
    @if (isOnlineGame) {
      <app-emote-menu />
      <app-emote-display />
      <app-chat-panel />
      <app-turn-timer [state]="state" />
    }

    <!-- Victory Dialog -->
    <p-dialog
      [(visible)]="showVictory"
      [modal]="true"
      [closable]="false"
      header="Partie terminée !"
      [style]="{ width: 'min(400px, 90vw)' }"
    >
      <div class="victory-content">
        <i class="pi pi-trophy victory-icon"></i>
        <h2>{{ getWinnerName() }} remporte la partie !</h2>
        <p>
          {{ state.player1.name }} : {{ state.player1.reputation }} PV
          &nbsp;—&nbsp;
          {{ state.player2.name }} : {{ state.player2.reputation }} PV
        </p>
      </div>
      <ng-template #footer>
        <p-button label="Nouvelle Partie" icon="pi pi-refresh" (onClick)="exitGame()" />
      </ng-template>
    </p-dialog>
  </div>
}
